<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>PrimaryAccess</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<style type="text/css">
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size: 13px;  
							padding: 0; margin:0px
							}
		.pa-main {		 	width: 100%;  background-color:#eee; height: vh; overflow-y: auto;
							}
		
		/* SCRIPT --------------------------------------------------------------------------------------------------*/

		.pa-script {		position: absolute; width: 50%; height: 100%; left:0; top:0; 
							background-color:#fff; height: calc(100% - 150px); overflow-y: scroll;
							}
		.pa-scriptPix {		display: inline-block; width: 126px; padding: 16px; height:80%; cursor:url(img/moveud.cur),auto;
							}
		.pa-scriptPic {		width: 128px; height: 85px; position: absolute; left: 16px; overflow: hidden;
							}
		.pa-scriptText {	display: inline-block; width: calc(100% - 240px); vertical-align: top;
							padding: 16px; font-size: 24px; line-height: 175%;
							}
		.pa-scriptText:focus{ outline:none;	
							}

		/* PLAYER --------------------------------------------------------------------------------------------------*/

		.pa-player {		position: absolute; width: 50%; left:50%; top: 0px; text-align: center;
							background-color:#ddd;  height:calc(100% - 150px); float: top
							}
		.pa-screen {		width:calc(100% - 32px); background-color: #666; border-radius: 8px;
							margin: 16px; margin-bottom: -4px; text-align:left; overflow: hidden;
							}
		.pa-time {			color: #666; padding: 12px 16px; font-size: 11px;
							}
		.pa-sliderBar {		width:calc(100% -3 2px); background-color: #aaa; height: 8px; 
							border-radius: 8px; margin: 16px; margin-top: 4px;
							}
		.pa-slider {  		position: absolute; width: 0; height: 0; border-bottom: 10px solid #009900; margin: 0 8px;
							border-left: 10px solid transparent; border-right: 10px solid transparent; cursor: pointer;
							}
		.pa-playbut {		cursor: pointer; margin: 0px 36px; width: 50px;
							}
		.pa-options {		border-radius: 10px; padding-left: 8px; width: 150px; vertical-align: 24px; 
							border: 1px solid #999; font-size: 14px; height: 20px; color:#666; cursor:pointer;
							background-color: #ccc; position: absolute; top: calc(100% - 32px);
							}
		.pa-options:focus{ outline:none;
							}
		.pa-move {			display: inline-block; color:#666; margin: 16px; background-color: #eee; 
							border: 1px solid #666; padding: 8px 0px 8px 8px;; border-radius: 8px; white-space: nowrap; 
							}
		.pa-movePic {		display: inline-block; cursor: pointer; width: 150px; height: 84px; margin: 2px; margin-bottom: -2px;
							background-color: #666; border: 3px solid #666; overflow: hidden; text-align: left; 
							}
	
		/* BIN --------------------------------------------------------------------------------------------------*/

		.pa-bin {			position: absolute; width: 100%; left:0; top: calc(100% - 150px);
							background-color:#eee; 	border-top: 1px solid #ccc;
							}
		.pa-binMenu {		display: inline-block; vertical-align: top; text-align:center; width: 150px;
							}							
		.pa-pix {			display: inline-block; overflow-x: scroll;  white-space: nowrap; width: calc(100% - 160px); 
							}
		.pa-pic {			padding: 8px; padding-right: 0; padding-bottom:4px; display: inline-block; cursor:url(img/movelr.cur),auto;
							}
		.pa-meta {			position: absolute;  width: 320px; padding: 16px; border-radius: 8px; font-size: 14px;
							background-color: #eee; border: 1px solid #999; box-shadow: -4px -4px 12px 2px #aaa;
							}
		
		/* MISC --------------------------------------------------------------------------------------------------*/
	
		.pa-arrow-down {  	position: absolute; left: calc(50% - 14px); top: 100%; width: 0; height: 0; 
							border-left: 10px solid transparent; border-right: 10px solid transparent;  border-top: 10px solid #bbb;
							}
		.pa-webpage	{ 		position: absolute; padding: 12px; border-radius: 6px; display: none; padding: 12px; height:auto; font-size: 14px; 
							border: 1px solid #999; background-color:#eee; font-size: 11px; box-shadow: 4px 4px 12px 2px #aaa;
							}
		.pa-is {			border-radius:10px; padding-left: 8px; padding-right: 8px; padding-top: 1px;
							border: 1px solid #999; font-size: 12px; height: 20px; width: 200px;
							}
		.pa-bs {			border-radius: 10px; padding-left: 8px; padding-right: 8px; background-color:#ccc; color: #333;
							border: 1px solid #666; font-size: 12px; height: 16px; cursor: pointer; width: 50px;
							}
		.pa-ok {			display:inline-block; border-radius: 20px; height: 18px; width: 22px; cursor: pointer;
							border: 1px solid #666; color: #666; font-size: 10px; padding-top: 4px;
							}
		.pa-arrow {  		cursor:pointer; vertical-align: 2px; display: none;
							}
 </style>

</head>
<body>
	<div id="mainDiv" class="pa-main">
		<div id="scriptDiv" class="pa-script">
			<div id="scriptPixDiv" class="pa-scriptPix"></div>	
			<div style="position:fixed;background-color:#ccc;width:6px;height:calc(100% - 186px);top:20px;left:160px;border-radius:2px;"></div>	
			<div id="scriptTextDiv" contenteditable="true" class="pa-scriptText">
				In the 1954 Brown v. Board of Education decision, segregated schools were declared unconstitutional. 
				This landmark decision sparked the modern Civil Rights movement.
				Led by Martin Luther King Jr., blacks engaged in a series of nonviolent protests throughout the southern United States.
				</div>		
		</div>	
		<div id="binDiv" class="pa-bin">
			<div id="binMenuDiv" class="pa-binMenu"></div>
			<img id='binLeftBut' src='img/leftarrow.png' class='pa-arrow'>
			<div id="binPixDiv" class="pa-pix"></div>
			<img id='binRightBut' src='img/rightarrow.png' class='pa-arrow'>
		</div>
		<div id="playerDiv" class="pa-player">
			<div id="screenDiv" class="pa-screen">
				<img id='screenPic' src="" style="position:relative">
			</div>
			<div class="pa-time">
				<span id="startTime" style="float:left"></span>
				<span id="endTime" style="float:right"></span>
			</div>
			<div id="sliderBarDiv" class="pa-sliderBar"></div>
			<div id="sliderDiv" class="pa-slider"></div>
			<select id="picOptions" class="pa-options" style="left:16px">
				<option>Picture options</option>
				<option>Set motion</option>
				<option>Closed caption</option>
				<option>Full screen</option>
				<option>Add new picture</option>
				</select>
			<img id="playBut" class="pa-playbut" src="img/playbut.gif">
			<select id="soundOptions" class="pa-options"  style="left:calc(100% - 166px">
				<option>Sound options</option>
				<option>Male voice</option>
				<option>Female voice</option>
				<option>Use MP3 file</option>
			</select>
		<br>
		<img id="paLogo" src="img/palogo2.png" style="margin-top:8px">
		<div id="moveDiv" class="pa-move">
			<div id="startDiv" style="display:inline-block">
				<b>Start</b><br><div id="startPic" class="pa-movePic"></div>
				<br><input id="slowInBut" type="checkbox" checked>Slow in
			</div>
			<div id="endDiv" style="display:inline-block">
				<b>End</b><br><div id="endPic" class="pa-movePic"></div>
				<br><input id="slowOutBut" type="checkbox" checked>Slow out
			</div>
			<br><div id="moveDoneBut" class="pa-bs" style="margin-left:auto;margin-right:auto;margin-top:-8px">Done</div>
		</div>
	</div>
<script>

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

	var bin=null;
	var script=null;
	var player=null;
	var isMobile=false;
	var playAspect=.6667;

	$(document).ready(function() {								        // ON PAGE LOADED
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag
		var url=window.location.search.substring(1);					 	// Get query string
		$(window).resize(ResizePanes);                                     	// On window resizing
		ResizePanes();														// Start up sizing
		bin=new CBin();														// Alloc CBin module
		script=new CScript();												// Alloc CScript module
		player=new CPlayer();												// Alloc CPlayer module

		$(window).on("keydown",function(e) {								// HANDLE KEYPRESS
			if (player.inMove) {											// In motion editor
				var pix=1/$("#screenDiv").width();							// Nudge amount
				var o=script.pics[player.curPic].pos[player.inMove-1];		// Point at position based on side
				if (e.which == 37)			o[0]-=pix;						// Nudge camera left
				else if (e.which == 39)		o[0]+=pix;						// Right
				else if (e.which == 38)		o[1]-=pix;						// Up
				else if (e.which == 40)		o[1]+=pix;						// Down
				player.DrawCamera(player.inMove-1);							// Move camera
				player.ScalePic(150,84,"#startImg",script.pics[player.curPic].pos[0]); // Set start
				player.ScalePic(150,84,"#endImg",script.pics[player.curPic].pos[1]);   // Set end
				}
			});

script.AddPic(7);player.curPic=0;script.Draw();player.Draw()

		});									
		
	function ResizePanes()												//  REACT TO SCREEN SIZE
	{
		if ($(window).width() < 800) {										// If narrow
			$("#scriptDiv").css({ width:"100%", height: "75%" });			// Script is whole width
			$("#binDiv").css({ top: "75%" });								// Bin below script
			$("#playerDiv").css({ width:"100%", height:"auto", left:0, top: "calc(75% + 150px)" });	// Player at bottom
			}
		else{																// Width screen
			$("#scriptDiv").css({ width:"60%", height:"calc(100% - 150px)" });	// Split screen
			$("#playerDiv").css({ width:"40%", height:"calc(100% - 150px)", left:"60%", top:0 });
			$("#binDiv").css({ top: $("#playerDiv").height() });			// Bin below both script and player
			}
		$("#screenDiv").height($("#screenDiv").width()*playAspect);				// 16 x 9 screen		
		var x=$("#sliderBarDiv").offset().left-8;							// Set left
		var y=$("#sliderBarDiv").offset().top+10;							// Set top
		$("#sliderDiv").offset({ left:x,top:y });							// Set slider						
		if (player)	player.Draw();											// Draw screen
	}


//////////////////////////////////////////////////////////////////////////////////////////////////
// PLAYER
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CPlayer()													// PLAYER CONSTRUCTOR
	{
		this.curPic=-1;														// Currently active picture
		this.inPlay=this.inMove=0;											// Default modes
		var _this=this;														// Save context
		this.curTime=0;														// Start at 0
		this.pos=[.5,.5,1];													// Current position
		$("#moveDiv").fadeOut(0);											// Hide move controls
		$("#startPic").height($("#startPic").width*playAspect);				// Scale to aspect
		$("#endPic").height($("#endPic").width*playAspect);					// Scale to aspect
		$("#sliderDiv").draggable( {										// Draggable slider
			axis: "x",														// X axis
			containment: "parent",											// Constrain
			drag: function(event, ui) {										// On drag
				if (!_this.inMove) {										// Not in motion editor
					_this.curTime=ui.position.left/($("#sliderBarDiv").width()-4)*script.maxTime; // Set time
					_this.Draw();											// Show position
					}
				}
			})

		$("#playBut").on("dblclick", function() {							// ON PLAYBUT DOUBLE CLICK
			_this.inPlay=!_this.inPlay;										// Toggle state
			_this.curTime=0;												// Set curtime to start
			if (_this.inMove) {												// In motion editor
				var s=script.pics[_this.curPic].start*script.speechRate;	// Start
				var se=script.pics[_this.curPic].end*script.speechRate;		// End
				_this.curTime=s;											// Set curtime
				_this.Play(s,se);											// Play or pause this clip
				}
			else															// Normal plat
				_this.Play(0,script.maxTime);								// Play or pause
			});

		$("#playBut").on("click", function() {								// ON PLAYBUT CLICK
			_this.inPlay=!_this.inPlay;										// Toggle state
			if (_this.inMove) {												// In motion editor
				var s=script.pics[_this.curPic].start*script.speechRate;	// Start
				var se=script.pics[_this.curPic].end*script.speechRate;		// End
				_this.Play(s,se);											// Play or pause this clip
				}
			else															// Normal plat
				_this.Play(0,script.maxTime);								// Play or pause
			});

		$("#picOptions").on("change", function() {							// ON PIC OPTIONS CHANGE
			if (($(this).val() == "Set motion") && (_this.curPic != -1)) {	// If setting motion on a valid pic
				_this.InitMotionEditor(1);									// Draw motion editor
				$("#paLogo").fadeOut(0);									// Hide logo
				$("#moveDiv").fadeIn();										// Show move controls
				}
			else															// Some other option											
				$(this).val("Picture options");								// Set menu to default
			});

		$("#soundOptions").on("change", function() {						// ON SOUND OPTIONS CHANGE
			$(this).val("Sound options");									// Restore menu
			}); 
	
		$("#moveDoneBut").on("click", function() {							// ON MOVE DONE CLICKED
			_this.inMove=0;													// Moving start
			$("#picOptions").val("Picture options");						// Restore menu
			$("#paLogo").fadeIn();											// Show logo
			$("#moveDiv").fadeOut(0);										// Hide move controls
			$("#cameraDiv").remove();										// Remove camera
			$("#picOptions").fadeIn();	$("#soundOptions").fadeIn();		// Show option buttons
			script.pics[_this.curPic].pos[0][3]=$("#slowInBut").prop("checked") ? 1 : 0;
			script.pics[_this.curPic].pos[1][3]=$("#slowOutBut").prop("checked") ? 1 : 0;
			_this.Draw();													// Draw screen
			script.Draw();													// Draw script
			});

		$("#startPic").on("click", function() {								// ON MOVE START CLICK
			_this.InitMotionEditor(1);										// Draw motion editor
			});
		
		$("#endPic").on("click", function() {								// ON MOVE END CLICK
			_this.InitMotionEditor(2);										// Draw motion editor
			});
		
		$("#playerDiv").disableSelection();									// Inhibit selection
		this.Draw();														// Draw screen
	}

	CPlayer.prototype.Draw=function() 									// UPDATE PLAYER
	{
		$("#startTime").text(SecondsToTimecode(Math.round(this.curTime)));	// Start display
		$("#endTime").text(SecondsToTimecode(Math.round(script.maxTime)));	// End display
		var x=$("#sliderBarDiv").offset().left-8;							// Set left
		var y=$("#sliderBarDiv").offset().top+10;							// Set top
		if (script.maxTime) 												// If some time in script
			x+=this.curTime/script.maxTime*($("#sliderBarDiv").width()-6);	// Move slider into position
		$("#sliderDiv").offset({ left:x, top:y });							// Set slider						
		var num=script.GetPicFromTime(this.curTime);						// Get current pic
		if (num != -1) {													// If on a picture
			$("#screenPic").show(0);										// Show pic
			this.curPic=num;												// Set current pic
			var o=script.pics[num];											// Point at pic
			$("#screenPic").prop("src",bin.pics[o.num].src);				// Set src
			var pct=(this.curTime-(o.start*script.speechRate))/(o.dur*script.speechRate);	// Point in move
			if (o.pos[0][3] && o.pos[0][3])									// Both
				pct=1.0-((Math.cos(3.1414*pct)+1)/2.0);						// Full cosine curve
			else if (o.pos[0][3])											// Slow in
				pct=1.0-(Math.cos(1.5707*pct));								// 1st quadrant of cosine curve
			else if (o.pos[1][3])											// Slow out
				pct=1.0-(Math.cos(1.5707+(1.5707*pct))+1.0);				// 2nd quadrant of cosine curve
			pct=Math.min(Math.max(pct,0),1);								// Cap 0-1
			this.pos[0]=(o.pos[0][0]+((o.pos[1][0]-o.pos[0][0])*pct));		// Calc x
			this.pos[1]=(o.pos[0][1]+((o.pos[1][1]-o.pos[0][1])*pct));		// Calc y
			this.pos[2]=(o.pos[0][2]+((o.pos[1][2]-o.pos[0][2])*pct));		// Calc w
			this.ScalePic($("#screenDiv").width(),$("#screenDiv").height(),"#screenPic",this.pos); // Set start
			}
		else																// No pic
			$("#screenPic").hide(0);										// Hide it
	}

	CPlayer.prototype.InitMotionEditor=function(mode)					// INIT MOTION EDITOR
	{
		var onCol="#009900", offCol="#666";									// Colors
		this.inMove=mode;													// Set moving mode to head
		$("#picOptions").hide(0);		$("#soundOptions").hide(0);			// Hide option buttons
		var num=script.pics[this.curPic].num;								// Picture to move
		$("#screenPic").prop("src",bin.pics[num].src);						// Set src
		var w=$("#screenPic")[0].naturalWidth/$("#screenPic")[0].naturalHeight*$("#screenDiv").height();
		$("#screenPic").css({ height:"100%",left:0,top:0,width:w+"px"});	// Top left, full height
		this.picWid=$("#screenPic").width();								// Save width
		this.picHgt=$("#screenDiv").height();								// Save height
		$("#startDiv").css("color",offCol);									// Mute start text
		$("#endPic").css("border","3px solid "+offCol);						// And border
		$("#endDiv").css("color",offCol);									// Mute end text
		$("#startPic").css("border","3px solid "+offCol);					// And border
		$("#slowInBut").prop("checked",script.pics[this.curPic].pos[0][3] == 1);	// Set in checkbox
		$("#slowOutBut").prop("checked",script.pics[this.curPic].pos[1][3] == 1)	// Set out
		$("#startPic").html("<img id='startImg' src='"+bin.pics[num].src+"' style='position:relative'>");	
		$("#endPic").html("<img id='endImg' src='"+bin.pics[num].src+"' style='position:relative'>");	
		this.ScalePic(150,84,"#startImg",script.pics[this.curPic].pos[0]);	// Init start
		this.ScalePic(150,84,"#endImg",script.pics[this.curPic].pos[1]);	// Init end

		if (mode == 1 ) {													// Set start
			$("#startDiv").css("color",onCol);								// Hilite  text
			$("#startPic").css("border","3px solid "+onCol);				// And border
			this.DrawCamera(0);												// Camera position
			}
		if (mode == 2 ) {													// Set end
			$("#endDiv").css("color",onCol);								// Hilite  text
			$("#endPic").css("border","3px solid "+onCol);					// And border
			this.DrawCamera(1);												// Camera position
			}
		}

	CPlayer.prototype.ScalePic=function(wid, hgt, image, pos)			// POSITION IMAGE
	{
		var nw=$(image)[0].naturalWidth;									// Get true width
		var nh=$(image)[0].naturalHeight;									// Get true height
		var fs=wid/nw;														// Frame scaling
		var s=1/pos[2];														// Reciprocal scale
		var w=nw*s*fs;														// Get image width scaled
		var h=nh*s*fs;														// Get image height
		var l=w*pos[0]-(w/s/2);												// Get left
		var t=h*pos[1]-(hgt/2);												// Get top
		$(image).css({"left":-l+"px","top":-t+"px",width:+w+"px",height:+h+"px"});	// Position image	
	} 

	CPlayer.prototype.DrawCamera=function(which) 						// DRAW CAMERA
	{
		var _this=this;														// Save context
		$("#cameraDiv").remove();											// Remove old one
		var o=script.pics[this.curPic].pos[which];							// Point at position based on side
		var w=$("#screenPic").width()*o[2]-1;								// Calc width
		var h=$("#screenPic").height()*o[2]-1;								// Calc height
		var str="<div id='cameraDiv' style='width:"+w+"px;height:"+w*playAspect;	// Size
		str+="px;cursor:url(img/move.cur),auto; ";							// Cursor
		str+= "px;border:1px solid yellow;position:absolute;border-radius:0px'>"
		str+="<div style='width:calc(100% - 4px);height:calc(100% - 4px);";
		str+= "border:2px solid #000;border-radius:0px'>";
		str+="<div style='width:calc(100% - 2x);height:calc(100% - 2px);";
		str+= "border:1px solid yellow;border-radius:0px'></div></div>"
		str+="<div id='camSizerBut' style='width:30px;height:32px;";
		str+="float:right;margin:-15px;cursor:nw-resize'>"
		str+="<div style='width:0;height:0;border-bottom: 10px solid yellow;";	
		str+="border-left: 10px solid transparent'</div></div>";
		$("#screenDiv").append("</div>"+str);								// Add camera to screen
		var cx=this.picWid*o[0]+(o[0]-w/2)+14;								// Calc camera left
		var cy=this.picHgt*o[1]+(o[1]-w*playAspect/2)+14;					// And top
		$("#cameraDiv").css({ left:cx, top:cy });							// Position camera
		$("#cameraDiv").draggable({											// Make camera draggable
			stop: function(event, ui) {										// On drag stop
				o[0]=(ui.position.left-14+$("#cameraDiv").width()/2)/$("#screenPic").width();	// Calc x
				o[1]=(ui.position.top-14+$("#cameraDiv").height()/2)/$("#screenPic").height();	// Calc y
				_this.ScalePic(150,84,"#startImg",script.pics[_this.curPic].pos[0]); // Set start
				_this.ScalePic(150,84,"#endImg",script.pics[_this.curPic].pos[1]);	 // Set end
				}
			});
		$("#camSizerBut").draggable({										// Make resizer draggable
			axis:"x",														// Constrict to x axis
			drag: function(event, ui) {										// On drag
				var x=event.clientX-$("#cameraDiv").offset().left;			// Position of camera left
				$("#cameraDiv").width(x);									// Size camera width
				$("#cameraDiv").height(x*playAspect);						// Height is proportional
				$(this).css("display","none");								// Hide resizer while dragging
				},
			stop: function(event, ui) {										// On drag stop
				$(this).css({display:"inline-block",left:"0px"});			// Force in box
				o[2]=$("#cameraDiv").width()/$("#screenPic").width();		// Set width
				o[0]=($("#cameraDiv").position().left-14+$("#cameraDiv").width()/2)/$("#screenPic").width();	// Calc x
				o[1]=($("#cameraDiv").position().top-14+$("#cameraDiv").height()/2)/$("#screenPic").height();	// Calc y
				_this.ScalePic(150,84,"#startImg",script.pics[_this.curPic].pos[0]); // Set start
				_this.ScalePic(150,84,"#endImg",script.pics[_this.curPic].pos[1]);	 // Set end
				}
			});
	}

	CPlayer.prototype.Play=function(start, end)							// START / STOP PLAYING 
	{
		var _this=this;														// Save context
		$("#cameraDiv").remove();											// Remove camera
		if (this.inPlay) {													// If playing
			var resetTime=start;											// Time to restart
			start=this.curTime;												// Set to start
			this.playerStart=new Date().getTime()							// Set start to now
			this.playerTimer=setInterval(function() {						// Set timer
				_this.curTime=start+(new Date().getTime()-_this.playerStart)/1000; // Get elapsed time from start
				_this.Draw();												// Show screen
				if (_this.curTime >= end) {									// If past end
					_this.curTime=resetTime;								// Set to reset point
					_this.inPlay=false;										// Toggle state
					_this.Play(0,0);										// Stop player
					_this.Draw();											// Show screen
					}
				},42);														// Set timer ~24ps
			$("#playBut").prop("src","img/pausebut.gif");					// Show pause but
			}
		else{																// If paused	
			clearInterval(this.playerTimer);								// Kill timer
			$("#playBut").prop("src","img/playbut.gif");					// Show play but
			}
	}






//////////////////////////////////////////////////////////////////////////////////////////////////
// SCRIPT
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CScript()													// SCRIPT CONSTRUCTOR
	{
		this.pics=[];														// Alloc array									
		this.Draw();														// Show bin
		var _this=this;														// Save context
		this.maxTime=18.5;													// Maximum time
		this.speechRate=.065;												// Seconds per char

		$("#scriptPixDiv").droppable({										// HANDLE DROPS TO BIN
			accept: ".pa-pic",												// Accept only pics from bin	  
			drop: function(event,ui) {										// On drop
				    if ($(this)) {											// If something
						$("#metaDiv").remove();								// Kill popup
						var id=ui.draggable[0].id.substr(7);				// Get id
						if (!player.inMove)									// If not in motion editor
							player.curPic=_this.pics.length;				// This is current pic
						_this.AddPic(id);									// Add to script
						Sound("ding");										// Ding
						_this.Draw();										// Show script
						}
				}
			});

		$("#scriptTextDiv")[0].addEventListener('input', function() {		// ON SCRIPT CHANGE
			_this.ResizeImageArea();										// Equilibrate fields
			_this.maxTime=$("#scriptTextDiv").text().length*_this.speechRate; // Set max time
			$("#endTime").text(SecondsToTimecode(Math.round(_this.maxTime)));// End display
			});
	}

	CScript.prototype.ResizeImageArea=function() 						//	MATCH IMAGE AREA TO TEXT AREA
	{
		$("#scriptPixDiv").height($("#scriptTextDiv").height())				// Make the same
	}

	CScript.prototype.Draw=function() 									//	DRAW SCRIPT
	{
		var i,y=24,str=""
		var _this=this;														// Save context
		for (i=0;i<this.pics.length;++i) {									// For each pic
			str+="<div id='scriptPic-"+i+"' class='pa-scriptPic' ";			// Container div 
			str+="style='top:"+y+"px'>";									// Pos
			str+="<img id='scriptImg-"+i+"' style='position:relative' ";	// Img
			str+="src='"+bin.pics[this.pics[i].num].src+"' ";				// Get source from bin
			str+="></div>"													// End div
			y+=100;
			}
		$("#scriptPixDiv").html(str);										// Show pix
		
		for (i=0;i<this.pics.length;++i) {									// For each pic
			player.ScalePic(128,85,"#scriptImg-"+i,script.pics[i].pos[0]); // Scale to start pos
			
			$("#scriptPic-"+i).on("click", function(e) {					// On click
				if (!player.inMove)	{										// If not in motion editor
					id=e.target.id.substr(10);								// Get index into script pics
					player.curPic=id;										// Set current pic
					player.curTime=_this.pics[id].start*_this.speechRate;	// Set start
					player.Draw();											// Draw
					}
				});	
			
			$("#scriptPic-"+i).draggable( {									// Allow drag
				start: function(event, ui) {								// If starting					
					$("#metaDiv").remove();									// Kill meta popup, if any
					if (!player.inMove)										// If not in motion editor
						player.curPic=ui.helper[0].id.substr(10);			// Set curpic
					},
				stop: function(event, ui) {									// If stopped						
					if (ui.position.left > 180) {							// Out of area
						_this.pics.splice(ui.helper[0].id.substr(10),1);	// Delete it
						Sound("delete");									// Sound
						if (!player.inMove)									// If not in motion editor
							player.curPic=-1;								// No current pic
					}
				_this.Draw();												// Redraw
				}	
			});
			}
	}

	CScript.prototype.AddPic=function(picNum) 							//	ADD PIC TO SCRIPT
	{
		var o={};															// Blank obj
		o.num=picNum;														// Add bin index
		o.dur=80;															// Duration in chars
		o.start=this.pics.length*80;										// Start time in chars
		o.end=o.start+o.dur;												// End if chars
		o.pos=[[.5,.5,.5,1],[.5,.5,.75,1]];									// Positions
		this.pics.push(o);													// Add to pics array
	}

	CScript.prototype.GetPicFromTime=function(now) 						//	GET CURRENT SCRIPT PICTURE
	{
		var o=this.pics;													// Point at pics
		now/=this.speechRate;												// Convert from time to char
		for (i=0;i<o.length;++i) 											// For each pic
			if ((now >= o[i].start) && (now < o[i].end))					// In this one
				return i;
		return -1;
	}

//////////////////////////////////////////////////////////////////////////////////////////////////
// BIN
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CBin()														// BIN CONSTRUCTOR
	{
		this.pics=this.LoadPics();											// Load default pics									
		this.Draw();														// Show bin
		
		var str="<img style='padding-top:16px' src='img/shantilogo.png'>"; 
		str+="<br><img  src='img/helpicon.gif'style='width:20px;margin:6px;margin-bottom:12px;cursor:pointer' onclick='bin.ShowHelp()'>"; 
		str+="<div style='color:#888;font-size:11px;line-height:100%'> &copy; 2018 University<br>of Virginia</div>";
		$("#binMenuDiv").html(str)
		$("#binDiv").disableSelection();									// Inhibit selection

		$("#binLeftBut").on("click", function() {							// Mobile scroll left
			$("#metaDiv").remove();											// Kill popup
			$("#binPixDiv").scrollLeft($("#binPixDiv").scrollLeft()-$("#binPixDiv").width()/2);
			if ($("#binPixDiv").scrollLeft())								// If scrolled
				$("#binLeftBut").show();									// Show
			else															// At start
				$("#binLeftBut").hide();									// Hide
			if (Math.abs($('#binPixDiv')[0].scrollWidth-$('#binPixDiv').outerWidth()) > 5)	// If it can scroll
				$("#binRightBut").show();									// Show
			});
		$("#binRightBut").on("click", function() {							// Right
			$("#metaDiv").remove();											// Kill popup
			$("#binPixDiv").scrollLeft($("#binPixDiv").scrollLeft()+$("#binPixDiv").width()/2);
			$("#binLeftBut").show();										// Show left
			if ($('#binPixDiv')[0].scrollWidth-$('#binPixDiv').scrollLeft()-$('#binPixDiv').outerWidth() < 20)	// If no scroll left
				$("#binRightBut").hide();									// Hide
			else															// At start
				$("#binRightBut").show();									// Show
			});
	}

	CBin.prototype.Draw=function() 										//	DRAW BIN
	{
		var i,str="";
		str+="<ul id='pixList' style='list-style-type:none;padding:0;margin:0'>"
		for (i=0;i<this.pics.length;++i) {									// For each pic
			str+="<li id='binPic-"+i+"' class='pa-pic'";					// List start
			str+="><img src='"+this.pics[i].src+"' style='margin:0;height:112px'></li>"; // Add image
			}

		$("#binPixDiv").html(str+"</ul>");									// Add to div
		$("#pixList").sortable();											// Make it sortable
 		$("#pixList").disableSelection();									// Imnhibit selection
	
		var _this=this;														// Save context
		for (i=0;i<this.pics.length;++i) {									// For each pic
			$("#binPic-"+i).on("mouseenter", function(e) {					// Add over handler
				$("#pa-webpage").remove();									// Remove old image, if any
				var id=e.currentTarget.id.substr(7);						// Get id
				_this.ShowMetaData(id);										// Show metadata popup
				});
			}
		if (isMobile) {														// Mobile doesn't show scroll bars
			if (Math.abs($('#binPixDiv')[0].scrollWidth-$('#binPixDiv').outerWidth()) > 5)	// If it can scroll
				$("#binRightBut").show();									// Show right
			$("#binPixDiv").css("width","calc(100% - 200px)");				// Shorten container div
			}		
	}

	CBin.prototype.ShowMetaData=function(num) 						//	SHOW METADATA POPUP
	{
		$("#metaDiv").remove();												// Kill old one
		var o=this.pics[num];												// Point at pic
		if (!o.title && !o.desc) 											// If nothing to show
			return;															// Quit
		var _this=this;														// Save context
		var str="<div id='metaDiv' class='pa-meta'>";						// Add div
		str+="<img id='zoomBut' src='img/zoomer.png' style='float:right;width:14px;cursor:pointer'>";	// Zoomer button
		if (o.title)														// If a title
			str+="<b>"+o.title+"</b><br><br>";								// Add it
		if (o.desc)															// If a description
			str+=o.desc;													// Add it
		if (o.link)															// If a link
			str+=" Click <a href=\""+o.link+"\" target=\"_blank\">here</a> for more information.";  // Add it
		str+="<div id='metaArrow' class='pa-arrow-down'></div>";			// Add div
		$("body").append(str+"</div>");										// Add popup
		var x=$("#binPic-"+num).offset().left-160+$("#binPic-"+num).width()/2;	// Center
		var off=x;															// Save pos
		x=Math.min(x,$(window).width()-360);								// Cap to window
		off-=x;																// Offset from end
		$("#metaArrow").css("left",Math.min(160+off,320)+"px");				// Position arrow
		var y=$("#binDiv").position().top-$("#metaDiv").height()-34;		// Align by bottom
		$("#metaDiv").offset({left:x,top:y});								// Position popup
	
		$("#scriptDiv").on("mouseenter", function() {						// Add over handler
			$("#metaDiv").remove();											// Kill old one
			});
		$("#playerDiv").on("mouseenter", function() {						// Add over handler
			$("#metaDiv").remove();											// Kill old one
			});
		$("#scriptDiv").on("click", function() {							// Add click handler
			$("#pa-webpage").remove();										// Remove old image, if any
			});
		$("#playerDiv").on("click", function() {							// Add click handler
			$("#pa-webpage").remove();										// Remove old image, if any
			});

		$("#zoomBut").on("click", function() {								// Show image popup
			_this.ShowPic(o.src,o.title);									// Show popup		
		});
	}
		
	CBin.prototype.ShowPic=function(url, title, desc) 					//	SHOW PIC
	{
		var div="#mainDiv";													// Enclosing div	
		$("#pa-webpage").remove();											// Remove old image, if any
		$("#metaDiv").remove();												// Kill metadata
		var str="<div id='pa-webpage' class='pa-webpage' style='";			// Add div
		str+="width:"+($(div).width()/2-40);								// Width
		str+="px;height:"+($("#scriptDiv").height()-44);					// Height
		str+="px;top:8px;left:8px'>";										// Finish div
		str+="<b>"+title+"</b><img id='pa-close' src='img/closedot.gif' style='float:right;cursor:pointer'><br><br>"	// Add close button
		str+="<div style='overflow-y:auto;height:calc(100% - 30px)'><img src='"+url+"' width='100%'></div>";	
		$("body").append(str+"</div>");										// Add popup
		$("#pa-webpage").fadeIn(1000);										// Fade in
		$("#pa-close").click(function() { $("#pa-webpage").remove(); });	// Remove on click of close but
	}

	CBin.prototype.ShowHelp=function() 									//	SHOW HELP
	{
		var div="#mainDiv";													// Enclosing div	
		$("#pa-webpage").remove();											// Remove old image, if any
		$("#metaDiv").remove();												// Kill metadata
		var str="<div id='pa-webpage' class='pa-webpage' style='";			// Add div
		str+="font-size:16px;width:"+($(div).width()/2-40);					// Width
		str+="px;height:"+($("#scriptDiv").height()-44);					// Height
		str+="px;top:8px;left:8px'>";										// Finish div
		str+="<b>PrimaryAccess user\'s Guide</b><img id='pa-close' src='img/closedot.gif' style='float:right;cursor:pointer'><br><br>"	// Add close button
		str+="<div style='overflow-y:auto;height:calc(100% - 30px)'>Help goes here.</div>";	
		$("body").append(str+"</div>");										// Add popup
		$("#pa-webpage").fadeIn(1000);										// Fade in
		$("#pa-close").click(function() { $("#pa-webpage").remove(); });	// Remove on click of close but
	}

	CBin.prototype.LoadPics=function() 									//	LOAD IMAGES
	{
		var pics=[];
		pics.push({ src:"//stagetools.com/primaryaccess/Test.jpg", 
			title:"Martin Luther King at Civil rights march",
			date: "1963",
			desc: "Martin Luther King delivers his \"I have a dream\" speech at the Lincoln Memorial",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0913-0914"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test2.jpg", 
			title:"Rosa Parks sitting on bus",
			date: "1955",
			desc: "Rosa Parks prompted outcry when she sat in the front of the bus.",
			link: "//teacher.scholastic.com/rosa"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test10.jpg", 
			title:"Brown vs. Board of Education",
			date: "1954",
			desc: "George E.C. Hayes, Thurgood Marshall, and James Nabrit, congratulating each other, following Supreme Court decision declaring segregation unconstitutional.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#09c"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test3.jpg", 
			title:"The Little Rock Nine",
			date: "1957",
			desc: "After the 1954 Brown school-desegregation decision, Little Rock school board officials decided to begin desegregation.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test4.jpg", 
			title:"The Little Rock Nine letter - Page 1",
			date: "1957",
			desc: "Letter from Daisy Bates to Roy Wilkins.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test5.jpg", 
			title:"The Little Rock Nine letter - Page 2",
			date: "1957",
			desc: "Letter from Daisy Bates to Roy Wilkins.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});			
		pics.push({ src:"//stagetools.com/primaryaccess/Test6.jpg", 
			title:"Greensboro Lunch Counter Sit-in",
			date: "1960",
			desc: "Ronald Martin, Robert Patterson, and Mark Martin stage sit-down strike after being refused service at an F.W. Woolworth luncheon counter, Greensboro, NC.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0909"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test7.jpg", 
			title:"Roger Wilkins, head of NAACP",
			date: "1957",
			desc: "Wilkins was excecutive secretary of the NAACP during the Little Rock Nine timeframe.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test8.jpg", 
			title:"Civil rights march on Washington",
			date: "1963",
			desc: "The August 28, 1963, March on Washington riveted the nation&apos;s attention. Rather than the anticipated hundred thousand marchers, more than twice that number appeared, astonishing even its organizers.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0913-0914"
			});
		return pics;
	}
	
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function TimecodeToSeconds(timecode) 									// CONVERT TIMECODE TO SECONDS
		{
			var h=0,m=0;
			var v=(""+timecode).split(":");										// Split by colons
			var s=v[0]															// Add them
			if (v.length == 2)													// Just minutes, seconds
				s=v[1],m=v[0];													// Add them
			else if (v.length == 3)												// Hours, minutes, seconds
				s=v[2],m=v[1],h=v[0];											// Add them
			return(Number(h*3600)+Number(m*60)+Number(s));						// Convert
		}
		
		function SecondsToTimecode(secs) 									// CONVERT SECONDS TO TIMECODE
		{
			var str="",n;
			n=Math.floor(secs/3600);											// Get hours
			if (n) str+=n+":";													// Add to tc
			n=Math.floor(secs/60);												// Get mins
			if (n < 10) str+="0";												// Add leading 0
			str+=n+":";															// Add to tc
			n=Math.floor(secs%60);												// Get secs
			if (n < 10) str+="0";												// Add leading 0
			str+=n;																// Add to tc
			return str;															// Return timecode			
		}	

	function DialogBox(title, content, width, callback, callback2) 			// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/logo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:14px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:Math.abs(width), buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$(this).remove();  
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
					            								$(this).remove(); }
									}});	
		if (width < 0)
			$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:this.parent });
		else
			$("#dialogDiv").dialog("option","position",{ my:"center", at:"center", of:this.parent });
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
	
</script>
</body>
</html>
