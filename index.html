  <!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>PrimaryAccess</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<style type="text/css">
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size: 13px;  
							padding: 0; margin:0px; 
							}
		.pa-main {		 	width: 100vw; min-width: 800px; overflow: auto;  background-color:#eee; opacity: 0; 
							}
		
		/* SCRIPT --------------------------------------------------------------------------------------------------*/

		.pa-script {		position: absolute; left:0; top:0; height: calc(100% - 150px); 
							background-color:#fff; overflow-y: scroll;
							}
		.pa-title {			width: calc(100% - 200px); margin-left: 176px; margin-top: 20px; 
		 					font-weight: bold; font-size: 30px;
							}
		.pa-scriptPix {		display: inline-block; width: 126px; padding: 16px; height:80%; cursor:url(img/moveud.cur),auto;
							}
		.pa-scriptPic {		width: 124px; height: 83px; position: absolute; left: 16px; overflow: hidden;
							border: 2px solid #999;
							}
		.pa-scriptText {	display: inline-block; width: calc(100% - 240px); vertical-align: top;
							padding: 16px; font-size: 24px; line-height: 175%;
							}
		.pa-scriptText:focus{ outline:none;	
							}

		/* PLAYER --------------------------------------------------------------------------------------------------*/

		.pa-player {		position: absolute; top: 0px; text-align: center; min-width: 380px;
							background-color:#ddd;  height:calc(100% - 150px); float: top;
							}
		.pa-screen {		width:calc(100% - 32px); background-color: #666; border-radius: 8px; 
							margin: 16px; margin-bottom: -4px; text-align:left; overflow: hidden;
							}
		.pa-time {			color: #666; padding: 12px 16px; font-size: 11px;
							}
		.pa-sliderBar {		width:calc(100% - 32px); background-color: #aaa; height: 8px; 
							border-radius: 8px; margin-left: 16px; margin-top: 4px;
							}
		.pa-slider {  		width: 0; height: 0; border-bottom: 10px solid #009900; margin: 0 8px;
							border-left: 10px solid transparent; border-right: 10px solid transparent; cursor: pointer;
							}
		.pa-playbut {		cursor: pointer; margin: 16px 0px 0px 0px; width: 50px;
							}
		.pa-options {		position: absolute; border-radius: 10px; width: 130px; height: 20px; padding: 0 8px;
							border: 1px solid #999;  color:#666; cursor:pointer; background-color: #ccc;
							}
		.pa-options:focus{ outline:none;
							}
		.pa-move {			display: inline-block; color:#666; background-color: #eee; box-shadow: 4px 4px 12px 2px #aaa;
							border: 1px solid #666; padding: 8px 0px 8px 8px;; border-radius: 8px; white-space: nowrap; 
							}
		.pa-movePic {		display: inline-block; cursor: pointer; width: 100px; height: 66px; margin: 2px; margin-bottom: -2px;
							background-color: #666; border: 3px solid #666; overflow: hidden; text-align: left; 
							}
		.pa-voice {			font-size: 10px; color: #999; 
							}


		/* BIN --------------------------------------------------------------------------------------------------*/

		.pa-bin {			position: absolute; width: 100%; left:0; top: calc(100% - 150px); height:149px;
							background-color:#eee; 	border-top: 1px solid #ccc;
							}
		.pa-binMenu {		display: inline-block; vertical-align: top; text-align:center; width: 150px;
							}							
		.pa-pix {			display: inline-block; overflow-x: scroll;  white-space: nowrap; width: calc(100% - 160px); 
							}
		.pa-pic {			padding: 8px; padding-right: 0; padding-bottom:4px; display: inline-block; cursor:url(img/movelr.cur),auto;
							}
		.pa-meta {			position: absolute;  width: 320px; padding: 16px; border-radius: 8px; font-size: 14px;
							background-color: #eee; border: 1px solid #999; box-shadow: -4px -4px 12px 2px #aaa;
							}
		
		/* MISC --------------------------------------------------------------------------------------------------*/
	
		.pa-splash			{ position:absolute; left: calc(50% - 182px); top:  calc(40% - 51px);
							}
		.pa-arrow-down {  	position: absolute; left: calc(50% - 14px); top: 100%; width: 0; height: 0; 
							border-left: 10px solid transparent; border-right: 10px solid transparent;  border-top: 10px solid #bbb;
							}
		.pa-webpage	{ 		position: absolute; padding: 12px; border-radius: 6px; display: none; padding: 12px; height:auto; font-size: 14px; 
							border: 1px solid #999; background-color:#eee; font-size: 11px; box-shadow: 4px 4px 12px 2px #aaa;
							}
		.pa-is {			border-radius:10px; padding-left: 8px; padding-right: 8px; padding-top: 1px;
							border: 1px solid #999; font-size: 12px; height: 20px; width: 200px;
							}
		.pa-bs {			display: inline-block; border-radius: 10px; padding-left: 8px; padding-right: 8px; background-color:#ccc; color: #333;
							border: 1px solid #999; font-size: 12px; height: 16px; cursor: pointer; width: 50px; text-align:center;
							}
		.pa-ok {			display:inline-block; border-radius: 20px; height: 18px; width: 22px; cursor: pointer;
							border: 1px solid #666; color: #666; font-size: 10px; padding-top: 4px;
							}
		.pa-arrow {  		cursor:pointer; vertical-align: 2px; display: none;
							}
		.pa-popup {			position: absolute;  width: 200px; padding: 16px;left: calc(50% - 100px); top: calc(50% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 4px 12px 2px #aaa; 
							font-size: 14px; display: none;
							}
 </style>

</head>
<body>
	<div id="mainDiv" class="pa-main">
		<div id="scriptDiv" class="pa-script">
			<div id="titleDiv" contenteditable="true" class="pa-title">Civil Rights</div>
			<div id="scriptPixDiv" class="pa-scriptPix"></div>	
			<div id="scriptDivider" style="position:absolute;background-color:#ccc;width:6px;height:calc(100% - 200px);top:20px;left:160px;border-radius:4px;"></div>	
			<div id="scriptTextDiv" contenteditable="true" class="pa-scriptText"></div>		
		</div>	
		<div id="binDiv" class="pa-bin">
			<div id="binMenuDiv" class="pa-binMenu"></div>
			<img id='binLeftBut' src='img/leftarrow.png' class='pa-arrow'>
			<div id="binPixDiv" class="pa-pix"></div>
			<img id='binRightBut' src='img/rightarrow.png' class='pa-arrow'>
		</div>
		<div id="playerDiv" class="pa-player">
			<div id="screenDiv" class="pa-screen">
				<img id='screenPic' src="" style="position:relative">
			</div>
			<div class="pa-time">
				<span id="startTime" style="float:left;cursor:pointer"></span>
				<span id="endTime" style="float:right"></span>
			</div>
			<div id="sliderBarDiv" class="pa-sliderBar"></div>
			<div id="sliderDiv" style="position:absolute;height:30px">
				<div class="pa-slider"></div>
			</div>
			<select id="picOptions" class="pa-options">
				<option>Picture options</option>
				<option>Set motion</option>
				<option>Full screen</option>
				<option>Add new picture</option>
				<option>Load show</option>
				</select>
			<img id="playBut" class="pa-playbut" src="img/playbut.gif"><br>
			<span id="activeVoice" class="pa-voice" ></span><br>
			<div id="soundOptions" class="pa-options" style="height:17px;padding:0" onclick="player.SoundSettings()">Sound options</div>
			<div id="moveDiv" class="pa-move">
				<div id="startDiv" style="display:inline-block">
					<b>Start</b><br><div id="startPic" class="pa-movePic"></div>
					<br><input id="slowInBut" type="checkbox" checked>Slow in
				</div>
				<div id="moveDoneBut" class="pa-bs" style="vertical-align:48px;padding:0;margin-right:5px;">Done</div>
				<div id="endDiv" style="display:inline-block">
					<b>End</b><br><div id="endPic" class="pa-movePic"></div>
					<br><input id="slowOutBut" type="checkbox" checked>Slow out
				</div>
			</div>
		</div>
	</div>
	<img id="splashDiv" class="pa-splash" src="img/palogo.gif">
<script>

	function PlayTTS()
	{
		player.inPlay=!player.inPlay;										// Toggle state
		if (player.inMove) {												// In motion editor
			var s=script.pics[player.curPic].start*player.speechRate;		// Start
			var se=script.pics[player.curPic].end*player.speechRate;		// End
			player.Play(s,se);												// Play or pause this clip
			}
		else																// Normal plat
			player.Play(0,player.maxTime);									// Play or pause
		if (!player.audio || (player.voice < 2))							// No TTS audio
			return;															// Quit
		speechSynthesis.cancel();											// Kill TTS queue
		if (!player.inPlay)													// Stop signal
			return;															// Quit
		var ar=player.audioRate/100;										// Speed
		player.speechRate=.070/ar;											// Adjust speechRate
		var pos=player.curTime/player.speechRate;							// Start of text
			player.audio.text=$("#scriptTextDiv").text().substr(pos);		// Set text							
		player.audio.rate=Math.max(.1,player.audioRate/100);				// Set rate 
		player.audio.pitch=(player.pitch/100);								// Set pitch 0-2
		if (ar > 1)			ar=1+(ar-1)*2;									// Scale 1-1.5 to 1-2
		else if (ar < 1)	ar=1-(ar*1.6);									// Scale .5-1 to .25-1
		player.audio.rate=ar;												// Set TTS audio rate .25 to 2
		speechSynthesis.speak(player.audio);								// Start
		player.maxTime=$("#scriptTextDiv").text().length*player.speechRate;	// Set max time
		$("#endTime").text(SecondsToTimecode(Math.round(player.maxTime)));	// End display
	}

//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

	var doc=null;															// Holds CDoc object
	var bin=null;															// CBin
	var script=null;														// CScript
	var player=null;														// CPplayer
	var isMobile=false;														// Is a mobile platform
	var noSplash=false;														// Splash screen inhibitor
	var playAspect=.6667;													// Image aspect ratio


	$(document).ready(function() {								        // ON PAGE LOADED
		isMobile=navigator.platform.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag id ios
		if (!isMobile)														// Check for Android
			isMobile=navigator.userAgent.match(/android/i) ? true : false; 	// Set mobile flag
		var url=window.location.search.substring(1);					 	// Get query string
		$(window).resize(ResizePanes);                                     	// On window resizing
		ResizePanes();														// Start up sizing
		doc=new CDoc();														// Alloc CDoc module
		bin=new CBin();														// Alloc CBin module
		script=new CScript();												// Alloc CScript module
		player=new CPlayer();												// Alloc CPlayer module
		ResizePanes();														// Start up sizing
		$("#splashDiv").delay(noSplash?1:1000).animate({ opacity:0},noSplash?1:500, // Hide logo
				function() {	 											// When done
					$("#mainDiv").animate({ opacity:1},noSplash?500:2000, 	// Show interface
						function() { $("#splashDiv").remove();	});			// Remove splash screen
				});

		$(window).on("keydown",function(e) {								// HANDLE KEYPRESS
			if (e.which == 32) {											// Spacebar
				var id=document.activeElement.id;							// Target id
				if (id  == "scriptTextDiv")		return;						// If in script
				if (id == "titleDiv")			return;						// If in title
				if (id && id.match(/add/))		return;						// If in add pic dialog
				$("#playBut").trigger("click");								// Toggle play
				}
			if (player.inMove) {											// In motion editor
				var pix=1/$("#screenDiv").width();							// Nudge amount
				var o=script.pics[player.curPic].pos[player.inMove-1];		// Point at position based on side
				if (e.which == 37)			o[0]-=pix;						// Nudge camera left
				else if (e.which == 39)		o[0]+=pix;						// Right
				else if (e.which == 38)		o[1]-=pix;						// Up
				else if (e.which == 40)		o[1]+=pix;						// Down
				player.DrawCamera(player.inMove-1);							// Move camera
				player.ScalePic(100,66,"#startImg",script.pics[player.curPic].pos[0]); // Set start
				player.ScalePic(100,66,"#endImg",script.pics[player.curPic].pos[1]);   // Set end
				}
			});

script.AddPic(1,0);player.curPic=0;script.Draw();player.Draw()
		});									
		
	function ResizePanes()												//  REACT TO SCREEN SIZE
	{
		var sw=$("#mainDiv").width()*.6;									// Script width
		var pw=$("#mainDiv").width()*.4;									// Player width
		var th=$("#titleDiv").height()+10;									// Get height of title bar
		$("#playerDiv").css({ width:pw+"px", left: sw+"px" });				// Position player
		$("#screenDiv").height($("#screenDiv").width()*playAspect);			// 16 x 9 screen		
		$("#playerDiv").css("min-height",$("#screenDiv").height()+132+"px");// Minimum height to preserve work area
		$("#scriptDiv").css({ width:sw+"px", height:$("#playerDiv").height()+"px" });	// Size script
		var oh=$("#screenDiv").height()+82;									// Options height
		pw=$("#screenDiv").width()/2;										// Center of player
		$("#picOptions").css({ left:(pw-160)+"px",top:oh+"px" });			// Set option					
		$("#soundOptions").css({ left:(pw+60)+"px",top:oh+"px" });			// Set option					
		var x=$("#sliderBarDiv").offset().left-8;							// Set left
		var y=$("#sliderBarDiv").offset().top+10;							// Set top
		$("#scriptDivider").css({ "margin-top": th, height: $("#scriptTextDiv").height()+16+"px" });
		$("#sliderDiv").offset({ left:x,top:y });							// Set slider						
		if ('ontouchstart' in document.documentElement) {					// Touch screens don't show scroll bars, so add a button
			if (Math.abs($("#binPixDiv")[0].scrollWidth-$("#binPixDiv").outerWidth()) > 5) 	// If it can scroll
				$("#binRightBut").show();									// Show right
			else{															// No scrolling
				$("#binRightBut").hide();									// Hide right
				$("#binPixDiv").css("width","calc(100% - 200px)");			// Shorten container div
				}
			}		
		$("#binDiv").css({ top:$("#playerDiv").height()+"px",width:pw+sw+"px" });	// Position bin below player
		if (script) script.Draw();											// Redraw script
		if (player)	player.Draw();											// Redraw player
		if (bin)	bin.Draw();												// Redraw bin
	}


//////////////////////////////////////////////////////////////////////////////////////////////////
// PLAYER
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CPlayer()													// PLAYER CONSTRUCTOR
	{
		this.curPic=-1;														// Currently active picture
		this.inPlay=this.inMove=0;											// Default modes
		var _this=this;														// Save context
		this.curTime=0;														// Start at 0
		this.pos=[.5,.5,1];													// Current position
		this.audio=null;													// Audio object
		this.voice=0;	this.pitch=100;										// TTS options
		this.speechRate=.065;												// Seconds per char
		this.maxTime=18.5;													// Maximum time
		this.audioRate=100;													// Rate multiplier

		$("#moveDiv").fadeOut(0);											// Hide move controls
		$("#startPic").height($("#startPic").width*playAspect);				// Scale to aspect
		$("#endPic").height($("#endPic").width*playAspect);					// Scale to aspect
		
		this.GetVoiceList()													// Set voice list up, in case event to triggered
		speechSynthesis.onvoiceschanged=function() {						// React to voice init
			_this.GetVoiceList();											// Set voice list up
			};

		$("#sliderDiv").draggable( {										// Draggable slider
			axis: "x",														// X axis
			containment: "parent",											// Constrain
			drag: function(event, ui) {										// On drag
				if (!_this.inMove) {										// Not in motion editor
					_this.curTime=ui.position.left/($("#sliderBarDiv").width()-4)*_this.maxTime; // Set time
					_this.Draw();											// Show position
					}
				}
			})

		$("#playerDiv").on("click", function() {							// ON PLAYER CLICK
			$("#metaDiv").remove();											// Kill metadata popup
			});

		$("#startTime").on("click", function() {							// ON START TIME CLICK
			_this.curTime=0;												// Set curtime to 0
			_this.Draw();													// Show position
			});

		$("#playBut").on("click", function() {								// ON PLAYBUT CLICK
			_this.inPlay=!_this.inPlay;										// Toggle state
			if (_this.inMove) {												// In motion editor
				var s=script.pics[_this.curPic].start*_this.speechRate;		// Start
				var se=script.pics[_this.curPic].end*_this.speechRate;		// End
				_this.Play(s,se);											// Play or pause this clip
				}
			else															// Normal plat
				_this.Play(0,_this.maxTime);								// Play or pause
			});

		$("#picOptions").on("change", function() {							// ON PIC OPTIONS CHANGE
			if (($(this).val() == "Set motion") && (_this.curPic != -1)) {	// If setting motion on a valid pic
				_this.InitMotionEditor(1);									// Draw motion editor
				$("#moveDiv").fadeIn();										// Show move controls
				}
			else if ($(this).val() == "Add new picture")					// Add pic
				bin.AddPic();												// Run pic dialog
			else if ($(this).val() == "Full screen")						// Full screen
				PopUp("Not implemented yet...",2000,"screenDiv");			// TBD	
			else if ($(this).val() == "Load show")							// Load show
				PopUp("Not implemented yet...",2000,"screenDiv");			// TBD	
			$(this).val("Picture options");									// Set menu to default
			});

		$("#soundOptions").on("click", function() {							// ON SOUND OPTIONS CLICK
			_this.SoundSettings();											// Change sound settings	
			$(this).val("Sound options");									// Set menu to default
			}); 
	
		$("#moveDoneBut").on("click", function() {							// ON MOVE DONE CLICKED
			_this.inMove=0;													// Moving start
			$("#picOptions").val("Picture options");						// Restore menu
			$("#moveDiv").fadeOut(0);										// Hide move controls
			$("#cameraDiv").remove();										// Remove camera
			$("#playerDiv").height($("#scriptDiv").height());				// Shorten
			script.pics[_this.curPic].pos[0][3]=$("#slowInBut").prop("checked") ? 1 : 0;
			script.pics[_this.curPic].pos[1][3]=$("#slowOutBut").prop("checked") ? 1 : 0;
			_this.Draw();													// Draw screen
			script.Draw();													// Draw script
			});

		$("#startPic").on("click", function() {								// ON MOVE START CLICK
			_this.InitMotionEditor(1);										// Draw motion editor
			});
		
		$("#endPic").on("click", function() {								// ON MOVE END CLICK
			_this.InitMotionEditor(2);										// Draw motion editor
			});
		
		$("#playerDiv").disableSelection();									// Inhibit selection
	}

	CPlayer.prototype.Draw=function() 									// UPDATE PLAYER
	{
		$("#startTime").text(SecondsToTimecode(Math.round(this.curTime)));	// Start display
		$("#endTime").text(SecondsToTimecode(Math.round(this.maxTime)));	// End display
		var x=$("#sliderBarDiv").offset().left-8;							// Set left
		var y=Math.round($("#sliderBarDiv").offset().top+10);				// Set top
		if (this.maxTime) 													// If some time in script
			x+=this.curTime/this.maxTime*($("#sliderBarDiv").width()-6);	// Move slider into position
		$("#sliderDiv").offset({ left:x, top:y });							// Set slider						
		var num=script.GetPicFromTime(this.curTime);						// Get current pic
		if (num != -1) {													// If on a picture
			$("#screenPic").show(0);										// Show pic
			this.curPic=num;												// Set current pic
			var o=script.pics[num];											// Point at pic
			$("#screenPic").prop("src",bin.pics[o.num].src);				// Set src
			var pct=(this.curTime-(o.start*this.speechRate))/(o.dur*this.speechRate);	// Point in move
			if (o.pos[0][3] && o.pos[0][3])									// Both
				pct=1.0-((Math.cos(3.1414*pct)+1)/2.0);						// Full cosine curve
			else if (o.pos[0][3])											// Slow in
				pct=1.0-(Math.cos(1.5707*pct));								// 1st quadrant of cosine curve
			else if (o.pos[1][3])											// Slow out
				pct=1.0-(Math.cos(1.5707+(1.5707*pct))+1.0);				// 2nd quadrant of cosine curve
			pct=Math.min(Math.max(pct,0),1);								// Cap 0-1
			this.pos[0]=(o.pos[0][0]+((o.pos[1][0]-o.pos[0][0])*pct));		// Calc x
			this.pos[1]=(o.pos[0][1]+((o.pos[1][1]-o.pos[0][1])*pct));		// Calc y
			this.pos[2]=(o.pos[0][2]+((o.pos[1][2]-o.pos[0][2])*pct));		// Calc w
			this.ScalePic($("#screenDiv").width(),$("#screenDiv").height(),"#screenPic",this.pos); // Set start
			}
		else																// No pic
			$("#screenPic").hide(0);										// Hide it
		script.Highlight("#0000ff",this.curTime/this.speechRate,2);		// Highlight position in text						
	}

	CPlayer.prototype.InitMotionEditor=function(mode)					// INIT MOTION EDITOR
	{
		var onCol="#009900", offCol="#666";									// Colors
		this.inMove=mode;													// Set moving mode to head
		var _this=this;														// Save context
		var num=script.pics[this.curPic].num;								// Picture to move
		$("#screenPic").prop("src",bin.pics[num].src);						// Set src
		var w=$("#screenPic")[0].naturalWidth/$("#screenPic")[0].naturalHeight*$("#screenDiv").height();
		$("#screenPic").css("transform","translate(0px,0px)");				// Identity matrix
		$("#screenPic").css({ height:"100%",left:0,top:0,width:w+"px"});	// Top left, full height
		this.picWid=$("#screenPic").width();								// Save width
		this.picHgt=$("#screenDiv").height();								// Save height
	
		$("#playerDiv").height($("#scriptDiv").height()+150);				// Extend full screen
		$("#startDiv").css("color",offCol);									// Mute start text
		$("#endPic").css("border","3px solid "+offCol);						// And border
		$("#endDiv").css("color",offCol);									// Mute end text
		$("#startPic").css("border","3px solid "+offCol);					// And border
		$("#slowInBut").prop("checked",script.pics[this.curPic].pos[0][3] == 1);	// Set in checkbox
		$("#slowOutBut").prop("checked",script.pics[this.curPic].pos[1][3] == 1)	// Set out
		$("#startPic").html("<img id='startImg' src='"+bin.pics[num].src+"' style='position:relative'>");	
		$("#endPic").html("<img id='endImg' src='"+bin.pics[num].src+"' style='position:relative'>");	
		this.ScalePic(100,66,"#startImg",script.pics[this.curPic].pos[0]);	// Init start
		this.ScalePic(100,66,"#endImg",script.pics[this.curPic].pos[1]);	// Init end
		
		$("#startPic").draggable({ zIndex: 100, axis: "x",					// Make start draggable to copy position to end
				stop: function(event, ui) {									// On drag stop
					if (ui.position.left > 100) {							// Over end 
						script.pics[_this.curPic].pos[1]=script.pics[_this.curPic].pos[0].slice(0);	// Clone key
						Sound("ding");										// Ding					
						_this.ScalePic(100,66,"#endImg",script.pics[_this.curPic].pos[1]);	 // Set end
						$(this).css("left",0);								// Revert
						$("#endPic").trigger("click");						// Highight end				
						}
					}
				})

		$("#endPic").draggable({ zIndex: 100, axis: "x",					// Make end draggable to copy position to start
				stop: function(event, ui) {									// On drag stop
					if (ui.position.left < 100) {							// Over end 
						script.pics[_this.curPic].pos[0]=script.pics[_this.curPic].pos[1].slice(0);	// Clone key
						Sound("ding");										// Ding					
						_this.ScalePic(100,66,"#startImg",script.pics[_this.curPic].pos[0]);	 // Set start
						$(this).css("left",0);								// Revert image
						$("#startPic").trigger("click");					// Highight start					
						}
					}
				})

		if (mode == 1 ) {													// Set start
			$("#startDiv").css("color",onCol);								// Hilite  text
			$("#startPic").css("border","3px solid "+onCol);				// And border
			this.DrawCamera(0);												// Camera position
			}
		if (mode == 2 ) {													// Set end
			$("#endDiv").css("color",onCol);								// Hilite  text
			$("#endPic").css("border","3px solid "+onCol);					// And border
			this.DrawCamera(1);												// Camera position
			}
		}

	CPlayer.prototype.ScalePic=function(wid, hgt, image, pos)			// POSITION IMAGE
	{
		var nw=$(image)[0].naturalWidth;									// Get true width
		var nh=$(image)[0].naturalHeight;									// Get true height
		var fs=wid/nw;														// Frame scaling
		var s=1/pos[2];														// Reciprocal scale
		var w=nw*s*fs;														// Get image width scaled
		var h=nh*s*fs;														// Get image height
		var l=w*pos[0]-(w/s/2);												// Get left
		var t=h*pos[1]-(hgt/2);												// Get top
		$(image).width(w); $(image).height(h);								// Size	
		$(image).css("transform","translate("+-l+"px,"+-t+"px)");			// Position
	} 

	CPlayer.prototype.DrawCamera=function(which) 						// DRAW CAMERA
	{
		var _this=this;														// Save context
		$("#cameraDiv").remove();											// Remove old one
		var o=script.pics[this.curPic].pos[which];							// Point at position based on side
		var w=$("#screenPic").width()*o[2]-1;								// Calc width
		var h=$("#screenPic").height()*o[2]-1;								// Calc height
		var str="<div id='cameraDiv' style='width:"+w+"px;height:"+w*playAspect;	// Size
		str+="px;cursor:url(img/move.cur),auto; ";							// Cursor
		str+= "px;border:1px solid yellow;position:absolute;border-radius:0px'>"
		str+="<div style='width:calc(100% - 4px);height:calc(100% - 4px);";
		str+= "border:2px solid #000;border-radius:0px'>";
		str+="<div style='width:calc(100% - 2x);height:calc(100% - 2px);";
		str+= "border:1px solid yellow;border-radius:0px'></div></div>"
		str+="<div id='camSizerBut' style='width:30px;height:32px;";
		str+="float:right;margin:-15px;cursor:nw-resize'>"
		str+="<div style='width:0;height:0;border-bottom: 10px solid yellow;";	
		str+="border-left: 10px solid transparent'</div></div>";
		$("#screenDiv").append("</div>"+str);								// Add camera to screen
		var cx=this.picWid*o[0]+(o[0]-w/2)+14;								// Calc camera left
		var cy=this.picHgt*o[1]+(o[1]-w*playAspect/2)+14;					// And top
		$("#cameraDiv").css({ left:cx, top:cy });							// Position camera
		$("#cameraDiv").draggable({											// Make camera draggable
			stop: function(event, ui) {										// On drag stop
				o[0]=(ui.position.left-14+$("#cameraDiv").width()/2)/$("#screenPic").width();	// Calc x
				o[1]=(ui.position.top-14+$("#cameraDiv").height()/2)/$("#screenPic").height();	// Calc y
				_this.ScalePic(100,66,"#startImg",script.pics[_this.curPic].pos[0]); // Set start
				_this.ScalePic(100,66,"#endImg",script.pics[_this.curPic].pos[1]);	 // Set end
				}
			});
		$("#camSizerBut").draggable({										// Make resizer draggable
			axis:"x",														// Constrict to x axis
			drag: function(event, ui) {										// On drag
				var x=event.pageX-$("#cameraDiv").offset().left;			// Position of camera left
				trace(event.pageX,event)
				x=Math.max(x,25);											// Not too small
				$("#cameraDiv").width(x);									// Size camera width
				$("#cameraDiv").height(x*playAspect);						// Height is proportional
				$(this).css("display","none");								// Hide resizer while dragging
				},
			stop: function(event, ui) {										// On drag stop
				$(this).css({display:"inline-block",left:"0px"});			// Force in box
				o[2]=$("#cameraDiv").width()/$("#screenPic").width();		// Set width
				o[0]=($("#cameraDiv").position().left-14+$("#cameraDiv").width()/2)/$("#screenPic").width();	// Calc x
				o[1]=($("#cameraDiv").position().top-14+$("#cameraDiv").height()/2)/$("#screenPic").height();	// Calc y
				_this.ScalePic(100,66,"#startImg",script.pics[_this.curPic].pos[0]); // Set start
				_this.ScalePic(100,66,"#endImg",script.pics[_this.curPic].pos[1]);	 // Set end
				}
			});
	}

	CPlayer.prototype.Play=function(start, end)							// START / STOP PLAYING 
	{
		var _this=this;														// Save context
		$("#cameraDiv").remove();											// Remove camera
		if (this.inPlay) {													// If playing
			this.StartAudio(this.curTime);									// Start	
			var resetTime=start;											// Time to restart
			start=this.curTime;												// Set to start
			this.playerStart=new Date().getTime()							// Set start to now
			this.playerTimer=setInterval(function() {						// Set timer
				_this.curTime=start+(new Date().getTime()-_this.playerStart)/1000; // Get elapsed time from start
				_this.Draw();												// Show screen
				if (_this.curTime >= end) {									// If past end
					_this.curTime=resetTime;								// Set to reset point
					_this.inPlay=false;										// Toggle state
					_this.Play(0,0);										// Stop player
					_this.Draw();											// Show screen
					}
				},42);														// Set timer ~24ps
			$("#playBut").prop("src","img/pausebut.gif");					// Show pause but
			}
		else{																// If paused	
			this.StartAudio(-1);											// Stop playing
			clearInterval(this.playerTimer);								// Kill timer
			$("#playBut").prop("src","img/playbut.gif");					// Show play but
		}
	}

//////////////////////////////////////////////////////////////////////////////////////////////////
// SOUND
/////////////////////////////////////////////////////////////////////////////////////////////////

	CPlayer.prototype.SoundSettings=function()						// SOUND SETTINGS DISLOG
	{
		var _this=this;														// Save context
		var x=$("#playerDiv").position().left+$("#playerDiv").width()/2-166;// Center in screen
		var y=$("#screenDiv").height()-220;									// Bottom of screen
		var str="Audio rate<div id='rateSlider' style='float:right;width:150px'></div><br>";
		str+="<div style='float:right;width:75px;border-left:1px solid #66cc66;margin-top:-1px;'>&nbsp;</div><br>";
		str+="Audio pitch<div id='pitchSlider'style='float:right;width:150px'></div><br><br>";
		str+="Voice<select id='voiceSel' class='pa-is' style='float:right'width:150px'><option>None</option><option>Use MP3 file</option><option>Default computer voice</option></select><br><br>";
		str+="MP3 file<input id='mp3Inp' type='text' class='pa-is' style='float:right;width:150px' value='http://stagetools.com/primaryaccess/narration.mp3'>";
		DialogBox("Sound Settings",str,x,y,300, function() {				// Run dialog			
			_this.pitch=$("#pitchSlider").slider("option", "value"); 		// Get pitch		
			_this.audioRate=$("#rateSlider").slider("option","value");		// Get rate		
			_this.voice=$("#voiceSel").prop("selectedIndex");				// Get voice
			_this.mp3=$("#mp3Inp").val();									// Get MP3 file
			_this.InitAudio();												// Init audio
			script.Draw();													// Redraw script
			_this.Draw();													// Redraw screen
			if (_this.voice == 1) 		$("#activeVoice").text("MP3 file");			// Show voice used	
			else if (_this.voice > 1) 	$("#activeVoice").text("Computer voice");	// Show voice used	
			else 						$("#activeVoice").text("");					// Show voice used	
			});
		for (i=0;i<this.voices.length;++i)									// For each voice
			$("#voiceSel").append("<option>"+this.voices[i].name+"</option>");	// Add to select
		$("#voiceSel").prop("selectedIndex",_this.voice);					// Set current voice
		$(this).val("Sound options");										// Set menu to default
		$("#pitchSlider").slider({ value:_this.pitch, step:5, min:0, max:200 });			// Init as slider 0-200
		$("#rateSlider").slider({ value:_this.audioRate, step:5, min:50, max:150 });		// Init as slider 50-150
		}

	CPlayer.prototype.InitAudio=function()								// INIT AUDIO
	{
		this.audio=null;													// Assume no audio						
		if ((this.voice == 1) && this.mp3)	{								// If an mp3 file
			this.audio=new Audio();											// Init audio object
			this.audio=new Audio(this.mp3);									// Load mp3 file
			}
		else if (this.voice > 1) {											// If text to speech
			speechSynthesis.cancel();										// Kill queue
			this.audio=new SpeechSynthesisUtterance();						// Init TTS
			if (this.voice > 2)
			this.audio.voice=this.voices[this.voice-3];						// Set voice
			}
		this.maxTime=$("#scriptTextDiv").text().length*.065/(this.audioRate/100);	// Set max time
		$("#endTime").text(SecondsToTimecode(Math.round(this.maxTime)));			// End display
	}

	CPlayer.prototype.StartAudio=function(time)							// PLAY/PAUSE AUDIO
	{
		this.speechRate=.065;												// Default speechRate
		if (!this.audio)													// No audio set up yet
			return;															// Quit
		var ar=this.audioRate/100;											// Speed
		if (this.voice == 1) {												// If an mp3 file
			if (time < 0)													// If stopping
				this.audio.pause();											// Stop playing
			else{															// If playing
				this.speechRate=.065/ar;									// Adjust speechRate
				this.audio.currentTime=this.curTime;						// Cue it up
				this.audio.playbackRate=ar;									// Set speed from .5 to 1.5
				if (this.audio.duration) {									// If a some duration
					if (this.audio.duration != Infinity)					// Not infinity
						this.speechRate=this.audio.duration/ar/$("#scriptTextDiv").text().length;	// Set speechRate to match mp3 file
					this.maxTime=$("#scriptTextDiv").text().length*this.speechRate;		// Set max time
					$("#endTime").text(SecondsToTimecode(Math.round(this.maxTime)));	// End display
					this.audio.play();										// Start playing
					}
				else														// Not loaded yet
					PopUp("MP3 file has not loaded yet",2000,"screenDiv");	// Popup
				}
			}
		else{																// Text to speech
			speechSynthesis.cancel();										// Kill TTS queue
			if (time >= 0) {												// If playing
				this.InitAudio();
				this.speechRate=.070/ar;									// Adjust speechRate
				var pos=this.curTime/this.speechRate;						// Start of text
				this.audio.text=$("#scriptTextDiv").text().substr(pos);		// Set text							
				this.audio.rate=Math.max(.1,this.audioRate/100);			// Set rate 
				this.audio.pitch=(this.pitch/100);							// Set pitch 0-2
				if (ar > 1)			ar=1+(ar-1)*2;							// Scale 1-1.5 to 1-2
				else if (ar < 1)	ar=1-(ar*1.6);							// Scale .5-1 to .25-1
				this.audio.rate=ar;											// Set TTS audio rate .25 to 2
				speechSynthesis.speak(this.audio);							// Start
				this.maxTime=$("#scriptTextDiv").text().length*this.speechRate;		// Set max time
				$("#endTime").text(SecondsToTimecode(Math.round(this.maxTime)));	// End display
				}
			}
	}

	CPlayer.prototype.GetVoiceList=function(time)						// SET VOICE LIST
	{
		var _this=this;														// Save context
		this.voices=[];														// New array
		voices=speechSynthesis.getVoices();									// Get voices
		voices.forEach(function(voice,index) {								// For each voice
			if (voice.lang == "en-US")										// Just look at English
				_this.voices.push(voice);									// Add voice
				});
	}
















//////////////////////////////////////////////////////////////////////////////////////////////////
// SCRIPT
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CScript()													// SCRIPT CONSTRUCTOR
	{
		this.pics=[];														// Alloc array									
		var _this=this;														// Save context

		$("#scriptDiv").droppable({											// HANDLE DROPS TO BIN
			accept: ".pa-pic", 												// Accept only pics from bin	  
			drop: function(event,ui) {										// On drop
				$("#metaDiv").remove();										// Kill popup
				var id=ui.draggable[0].id.substr(7);						// Get id
				if (!player.inMove)											// If not in motion editor
					player.curPic=_this.pics.length;						// This is current pic
				var pos=$("#"+ui.draggable[0].id).offset().top;				// Get y pos of image
				var pos=ui.offset.top+$("#scriptDiv").scrollTop();			// Get unscrolled pos
				pos=_this.GetPosFromPic(pos);								// Get char pos
				_this.AddPic(id,pos);										// Add to script
				Sound("ding");												// Ding
				_this.Draw();												// Show script
				$("#scriptPic-"+(_this.pics.length-1)).trigger("click");	// Set as current
				}
			});

var str="In the 1954 Brown v. Board of Education decision, segregated schools were declared unconstitutional. This landmark decision sparked the modern Civil Rights movement. Led by Martin Luther King Jr., blacks engaged in a series of nonviolent protests throughout the southern United States."
$("#scriptTextDiv").text(str);
			
			$("#scriptTextDiv")[0].addEventListener('input', function() {		// ON SCRIPT CHANGE
			_this.ResizeImageArea();										// Equilibrate fields
			player.maxTime=$("#scriptTextDiv").text().length*player.speechRate; // Set max time
			$("#endTime").text(SecondsToTimecode(Math.round(player.maxTime)));// End display
			});
	}

	CScript.prototype.ResizeImageArea=function() 						//	MATCH IMAGE AREA TO TEXT AREA
	{
		$("#scriptPixDiv").height($("#scriptTextDiv").height())				// Make the same
		$("#scriptDivider").height($("#scriptTextDiv").height()+16);		// Set divider
	}

	CScript.prototype.Draw=function() 									//	DRAW SCRIPT
	{
		var i,y,str=""
		var _this=this;														// Save context
		var cpl=$("#scriptTextDiv").width()/15;								// Characters/line
		var offy=$("#scriptTextDiv").offset().top+24;						// Offset of title
		offy+=$("#scriptDiv").scrollTop();									// Account for scroll
		for (i=0;i<this.pics.length;++i) {									// For each pic
			y=(this.pics[i].start/cpl*40)+offy;								// Calc y pos			
			str+="<div id='scriptPic-"+i+"' class='pa-scriptPic' ";			// Container div 
			str+="style='top:"+y+"px'>";									// Pos
			str+="<img id='scriptImg-"+i+"' style='position:relative' ";	// Img
			str+="src='"+bin.pics[this.pics[i].num].src+"' ";				// Get source from bin
			str+="></div>"													// End div
			}
		$("#scriptPixDiv").html(str);										// Show pix
		
		for (i=0;i<this.pics.length;++i) {									// For each pic
			player.ScalePic(128,85,"#scriptImg-"+i,script.pics[i].pos[0]); 	// Scale to start pos
			
			$("#scriptPic-"+i).on("click", function(e) {					// On click
				if (!player.inMove)	{										// If not in motion editor
					id=e.target.id.substr(10);								// Get index into script pics
					player.curPic=id;										// Set current pic
					player.curTime=_this.pics[id].start*player.speechRate;	// Set start
					player.Draw();											// Draw
					_this.Highlight("#cc0000",_this.pics[id].start,_this.pics[id].dur);	// Highlight text					
					$("[id^=scriptPic-]").css("border","2px solid #999");	// Kill borders
					$(this).css("border","2px solid #cc0000");				// Add border
					}
				});	
			
			$("#scriptPic-"+i).draggable( {									// Allow drag
				axis: "y",													// Constrain to y axis
				start: function(event, ui) {								// If starting					
					$("#metaDiv").remove();									// Kill meta popup, if any
					if (!player.inMove)										// If not in motion editor
						player.curPic=ui.helper[0].id.substr(10);			// Set curpic
					},
				drag: function(event, ui) {									// If stopped						
					$("#metaDiv").remove();									// Kill metadata popup
					var id=ui.helper[0].id.substr(10);						// Get id
					var pos=_this.GetPosFromPic(ui.position.top);			// Calc char pos
					_this.Highlight("#0000ff",pos,2,true);					// Highlight position in text & inhibit scrolling						
					},
				stop: function(event, ui) {									// If stopped						
					if (ui.position.top < -75) {							// Off the top
						_this.pics.splice(ui.helper[0].id.substr(10),1);	// Delete it
						Sound("delete");									// Sound
						if (!player.inMove)									// If not in motion editor
							player.curPic=-1;								// No current pic
						}
					else{													// Normal move
						var id=ui.helper[0].id.substr(10);					// Get id
						var pos=_this.GetPosFromPic(ui.position.top);		// Calc char pos
						_this.SetPicStartTime(id,pos);						// Set pic start time
						_this.ResolvePicTimes();							// Make pic times a solid stream
						$("#scriptPic-"+id).trigger("click");				// Set as current
						}
	
				_this.Draw();												// Redraw
				}	
			});
		}
	}

	CScript.prototype.SetPicStartTime=function(id, pos) 				//	SET PIC START TIME
	{
		if (id == 0) {														// First pic
			var dest=Math.max(0,this.GetPicFromTime(pos*player.speechRate));	// Get pic we're over
			if (dest && (pos > this.pics[dest].start)) {					// If moving down, flop
				var t=$.parseJSON(JSON.stringify(this.pics[dest]));			// Clone [dest]
				this.pics[dest]=$.parseJSON(JSON.stringify(this.pics[id]));	// Flop with clone
				this.pics[id]=t;											// Copy back temp
				this.pics[dest].start=t.start;								// Set time
				}
			pos=0;															// Force to top
		}
		this.pics[id].start=Math.round(pos);								// Set start
	}

	CScript.prototype.GetPosFromPic=function(pos) 
	{
		var cpl=$("#scriptTextDiv").width()/15;								// Characters/line
		var offy=$("#scriptTextDiv").offset().top+24;						// Offset of title
		offy+=$("#scriptDiv").scrollTop();									// Account for scroll
		return (pos-offy)/40*cpl;											// Return char pos
	}

	CScript.prototype.AddPic=function(picNum, when) 					//	ADD PIC TO SCRIPT
	{
		var o={};															// Blank obj
		var n=this.pics.length;												// Number of pics
		o.num=picNum;														// Add bin index
		o.pos=[[.5,.4,.75,1],[.5,.5,.5,1]];									// Positions
		this.pics.push(o);													// Add to pics array
		this.SetPicStartTime(n,when);										// Set pic start time
		this.ResolvePicTimes();												// Make times a solid stream
	}

	CScript.prototype.ResolvePicTimes=function() 						// RESOLVE PIC TIMES
	{
		var i,pre;
		var o=this.pics;													// Point at pics
		o.sort(function(a,b) { return a.start-b.start });					// Sort by start
		var last=o.length-1;												// Point at last pic
		var e=Math.round(player.maxTime/player.speechRate);					// End of script in chars
		if (last < 0)														// No pics yet
			return;															// Quit
		o[0].start=0;														// First pic always starts at 0
		for (i=1;i<=last;++i) {												// For each pic past 1st
			pre=i-1;														// Point a previous pic														
			o[pre].dur=Math.max(0,o[i].start-o[pre].start);					// Dur is delta from this to last
			o[pre].end=o[pre].start+o[pre].dur;								// Calc end
			}
		o[last].dur=Math.max(0,e-o[last].start);							// Fill last pix to script end	
		o[last].end=e;														// Set end
		this.Draw();														// Redraw	
	}

	CScript.prototype.GetPicFromTime=function(now) 						//	GET CURRENT SCRIPT PICTURE
	{
		var o=this.pics;													// Point at pics
		if (!player)														// If no player yet
			return -1;														// Return no pic
		now/=player.speechRate;												// Convert from time to char
		for (i=0;i<o.length;++i) 											// For each pic
			if ((now >= o[i].start) && (now < o[i].end))					// In this one
				return i;													// Return index
		return -1;															// No pic
	}

	CScript.prototype.Highlight=function(col, pos, width, noScroll) 	//	HIGHLIGHT SCRIPT TEXT
	{
		var cpl=$("#scriptTextDiv").width()/15;								// Characters/line
		var txt=$("#scriptTextDiv").text();									// Get raw text
		var n=txt.length;													// Length of text
		pos=Math.max(Math.round(pos),0);									// Cap at 0
		width=Math.round(width);											// Round
		if (pos >= n)														// Start is past script length
			return;															// Quit
		if (pos+width > n)													// If end id past length
			width=(n-pos+1);												// Cap at end
		var str=txt.substr(0,pos)+"<span style='";							// Add start
		if (width < 8)														// If narrow
			str+="border-bottom: 4px solid ";								// Use underline
		else																// If wide
			str+="color: ";													// Color
		str+=col+";'>"														// Finish span
		str+=txt.substr(pos,width);											// Add highlight portion
		str+="</span>"+txt.substr(pos+width)								// Close span and add rest of text
		$("#scriptTextDiv").html(str);										// Set colored text in
		if (noScroll)														// If dragging pic
			return;															// Don;t scrooll
		var y=pos/cpl*40;													// Scroll point
		$("#scriptDiv").scrollTop(y-$("#scriptDiv").height()/2);			// Scroll text
	}
















//////////////////////////////////////////////////////////////////////////////////////////////////
// BIN
/////////////////////////////////////////////////////////////////////////////////////////////////

	function CBin()														// BIN CONSTRUCTOR
	{
		this.pics=this.LoadPics();											// Load default pics									
		var str="<img style='padding-top:16px' src='img/shantilogo.png'>"; 
		str+="<br><img  src='img/helpicon.gif'style='width:20px;margin:6px;margin-bottom:12px;cursor:pointer' onclick='bin.ShowHelp()'>"; 
		str+="<div style='color:#888;font-size:11px;line-height:100%'> &copy; 2018 University<br>of Virginia</div>";
		$("#binMenuDiv").html(str);											// Show menu
		$("#binDiv").disableSelection();									// Inhibit selection
		this.Draw();														// Show bin

		$("#binLeftBut").on("click", function() {							// Mobile scroll left
			$("#metaDiv").remove();											// Kill popup
			$("#binPixDiv").scrollLeft($("#binPixDiv").scrollLeft()-$("#binPixDiv").width()/2);
			if ($("#binPixDiv").scrollLeft())								// If scrolled
				$("#binLeftBut").show();									// Show
			else															// At start
				$("#binLeftBut").hide();									// Hide
			if (Math.abs($('#binPixDiv')[0].scrollWidth-$('#binPixDiv').outerWidth()) > 5)	// If it can scroll
				$("#binRightBut").show();									// Show
			});
		
		$("#binRightBut").on("click", function() {							// Right
			$("#metaDiv").remove();											// Kill popup
			$("#binPixDiv").scrollLeft($("#binPixDiv").scrollLeft()+$("#binPixDiv").width()/2);
			$("#binLeftBut").show();										// Show left
			if ($('#binPixDiv')[0].scrollWidth-$('#binPixDiv').scrollLeft()-$('#binPixDiv').outerWidth() < 20)	// If no scroll left
				$("#binRightBut").hide();									// Hide
			else															// At start
				$("#binRightBut").show();									// Show
			});
	}

	CBin.prototype.Draw=function() 										//	DRAW BIN
	{
		var i,str="";
		var _this=this;														// Save context
		str+="<ul id='pixList' style='list-style-type:none;padding:0;margin:0'>"
		for (i=0;i<this.pics.length;++i) {									// For each pic
			str+="<li id='binPic-"+i+"' class='pa-pic'";					// List start
			str+="><img src='"+this.pics[i].src+"' style='margin:0;height:112px'></li>"; // Add image
			}

		$("#binPixDiv").html(str+"</ul>");									// Add to div
		$("#pixList").sortable({ 											// Make it sortable
			sort: function(event, ui) {										// On pic drag
				$("#metaDiv").remove();										// Kill meta popup, if any on sort
				if (ui.offset.left < 120) {									// In script pic area
					var pos=ui.offset.top+$("#scriptDiv").scrollTop();		// Get unscrolled pos
					pos=script.GetPosFromPic(pos);							// Calc char pos
					script.Highlight("#0000ff",pos,2,true);					// Highlight position in text & inhibit scrolling						
					}
				}
			});
		$("#pixList").disableSelection();									// Imnhibit selection
	
		var _this=this;														// Save context
		for (i=0;i<this.pics.length;++i) {									// For each pic
			$("#binPic-"+i).on("click", function(e) {						// Add over handler
				$("#pa-webpage").remove();									// Remove old image, if any
				var id=e.currentTarget.id.substr(7);						// Get id
				_this.ShowMetaData(id);										// Show metadata popup
				});
			}
	}

	CBin.prototype.ShowMetaData=function(num) 						//	SHOW METADATA POPUP
	{
		$("#metaDiv").remove();												// Kill old one
		var o=this.pics[num];												// Point at pic
		if (!o.title && !o.desc) 											// If nothing to show
			return;															// Quit
		var _this=this;														// Save context
		var str="<div id='metaDiv' class='pa-meta'>";						// Add div
		str+="<img id='zoomBut' src='img/zoomer.png' style='float:right;width:14px;cursor:pointer'>";	// Zoomer button
		if (o.title)														// If a title
			str+="<b>"+o.title+"</b><br><br>";								// Add it
		if (o.desc)															// If a description
			str+=o.desc;													// Add it
		if (o.link)															// If a link
			str+=" Click <a href=\""+o.link+"\" target=\"_blank\">here</a> for more information.";  // Add it
		str+="<div id='metaArrow' class='pa-arrow-down'></div>";			// Add div
		$("body").append(str+"</div>");										// Add popup
		var x=$("#binPic-"+num).offset().left-160+$("#binPic-"+num).width()/2;	// Center
		var off=x;															// Save pos
		x=Math.min(x,$(window).width()-360);								// Cap to window
		off-=x;																// Offset from end
		$("#metaArrow").css("left",Math.min(160+off,320)+"px");				// Position arrow
		var y=$("#binDiv").offset().top-$("#metaDiv").height()-16;			//	 Align by bottom
		$("#metaDiv").offset({left:x,top:y});								// Position popup
	
		$("#scriptDiv").on("mouseenter", function() {						// Add over handler
			$("#metaDiv").remove();											// Kill old one
			});
		$("#playerDiv").on("mouseenter", function() {						// Add over handler
			$("#metaDiv").remove();											// Kill old one
			});
		$("#scriptDiv").on("click", function() {							// Add click handler
			$("#pa-webpage").remove();										// Remove old image, if any
			});
		$("#playerDiv").on("click", function() {							// Add click handler
			$("#pa-webpage").remove();										// Remove old image, if any
			});

		$("#zoomBut").on("click", function() {								// Show image popup
			_this.ShowPic(num);												// Show popup		
		});
	}
		
	CBin.prototype.AddPic=function()									// ADD NEW PICTURE DIALOG
	{
		var _this=this;														// Save context
		var x=$("#mainDiv").width()/2-266;									// Center in main screen
		var y=$("#scriptDiv").height()/2-100;								// Center
		var str="<div style='display:inline-block'><table style='width:300px'>";	// Info div/table
		str+="<tr><td>Title</td><td><input id='addTitle' type='text' class='pa-is' style='width:100%'</td></tr>";
		str+="<tr><td>URL</td><td><input id='addUrl' type='text' class='pa-is' style='width:100%'></td></tr>";
		str+="<tr><td>Desc&nbsp;&nbsp;</td><td><textarea id='addDesc' type='text' class='pa-is' style='width:100%;height:50px'></textarea></td></tr>";
		str+="<tr><td>Link</td><td><input id='addLink' type='text' class='pa-is' style='width:100%'>";
		str+="</table></div>";														// End div
		str+="<div style='display:inline-block;overflow:hidden;width:160px;margin-left:32px;vertical-align:top'>";
		str+="<img id='addImg' src='img/newbinpic.png' style='width:100%'></div>";
			
		DialogBox("Add new picture",str,x,y,500, function() {				// Run dialog			
			var o={};
			o.src=$("#addUrl").val() ? $("#addUrl").val() : "";				// Add src
			o.title=$("#addTitle").val() ? $("#addTitle").val() : "";		// Add title
			o.desc=$("#addDesc").val() ? $("#addDesc").val() : "";			// Add desc
			o.link=$("#addLink").val() ? $("#addLink").val() : "";			// Add link
			_this.pics.push(o);												// Add to bin
			Sound("ding");													// Ding
			_this.Draw();													// Redraw bin
			});

		$("#addUrl").on("change", function() {								// ON IMAGE URL SET
			$("#addImg").prop("src",$(this).val());							// Show it
			});
	}

	CBin.prototype.ShowPic=function(num) 								//	SHOW PIC
	{
		$("#pa-webpage").remove();											// Remove old image, if any
		$("#metaDiv").remove();												// Kill metadata
		var o=this.pics[num];												// Point at pic
		var str="<div id='pa-webpage' class='pa-webpage' style='";			// Add div
		str+="width:"+($("#scriptDiv").width()-24);							// Width
		str+="px;height:"+($("#scriptDiv").height()-44);					// Height
		str+="px;top:8px;left:8px'>";										// Finish div
		str+="<b>"+o.title+"</b><img id='pa-close' src='img/closedot.gif' style='float:right;cursor:pointer'><br><br>"	// Add close button
		str+="<div style='overflow-y:auto;height:calc(100% - 30px)'><img src='"+o.src+"' width='100%'>";	
		if (o.desc)	{														// If a description
			str+="<br><br>"+o.desc;												// Add it
			if (o.link)														// If a link
				str+=" Click <a href=\""+o.link+"\" target=\"_blank\">here</a> for more information.";  // Add it
			}
		$("body").append("</div>"+str+"</div>");							// Add popup
		$("#pa-webpage").fadeIn(1000);										// Fade in
		$("#pa-close").click(function() { $("#pa-webpage").remove(); });	// Remove on click of close but
	}

	CBin.prototype.ShowHelp=function() 									//	SHOW HELP
	{
		var div="#mainDiv";													// Enclosing div	
		$("#pa-webpage").remove();											// Remove old image, if any
		$("#metaDiv").remove();												// Kill metadata
		var h=$("#scriptDiv").height()-44;									// Height
		var str="<div id='pa-webpage' class='pa-webpage' style='";			// Add div
		str+="font-size:13px;width:"+(h*.77);								// Width proportion to 8.x x 11 page
		str+="px;height:"+h+"px;top:8px;left:8px'>";						// Finish div
		str+="<b> PrimaryAccess User&apos;s Guide</b><img id='pa-close' src='img/closedot.gif' style='float:right;cursor:pointer;padding-bottom:12px'><br>"	// Add close button
//		str+="<div style='-webkit-overflow-scrolling:touch'>";
		str+="<iframe src='https://docs.google.com/document/d/e/2PACX-1vQQlE8nxS33bkI5CY--daR1ibM-7q6B-GFrztW6cq9lN6FNztpA_b0nrQiV33krohd5O6dvyU1ibiGU/pub?embedded=true' "; 
		str+="style='width:100%;height:"+(h-30)+"px;overflow-y:scroll'></iframe>";
		$("body").append(str+"</div>");										// Add popup
		$("#pa-webpage").fadeIn(1000);										// Fade in
		$("#pa-webpage").draggable();										// Make it draggable
		$("#pa-close").click(function() { $("#pa-webpage").remove(); });	// Remove on click of close but
	}

	CBin.prototype.LoadPics=function() 									//	LOAD IMAGES
	{
		var pics=[];
		pics.push({ src:"//stagetools.com/primaryaccess/Test.jpg", 
			title:"Martin Luther King at Civil rights march",
			date: "1963",
			desc: "Martin Luther King delivers his \"I have a dream\" speech at the Lincoln Memorial",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0913-0914"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test2.jpg", 
			title:"Rosa Parks sitting on bus",
			date: "1955",
			desc: "Rosa Parks prompted outcry when she sat in the front of the bus.",
			link: "//teacher.scholastic.com/rosa"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test10.jpg", 
			title:"Brown vs. Board of Education",
			date: "1954",
			desc: "George E.C. Hayes, Thurgood Marshall, and James Nabrit, congratulating each other, following Supreme Court decision declaring segregation unconstitutional.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#09c"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test3.jpg", 
			title:"The Little Rock Nine",
			date: "1957",
			desc: "After the 1954 Brown school-desegregation decision, Little Rock school board officials decided to begin desegregation.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test4.jpg", 
			title:"The Little Rock Nine letter - Page 1",
			date: "1957",
			desc: "Letter from Daisy Bates to Roy Wilkins.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test5.jpg", 
			title:"The Little Rock Nine letter - Page 2",
			date: "1957",
			desc: "Letter from Daisy Bates to Roy Wilkins.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});			
		pics.push({ src:"//stagetools.com/primaryaccess/Test6.jpg", 
			title:"Greensboro Lunch Counter Sit-in",
			date: "1960",
			desc: "Ronald Martin, Robert Patterson, and Mark Martin stage sit-down strike after being refused service at an F.W. Woolworth luncheon counter, Greensboro, NC.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0909"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test7.jpg", 
			title:"Roger Wilkins, head of NAACP",
			date: "1957",
			desc: "Wilkins was excecutive secretary of the NAACP during the Little Rock Nine timeframe.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9.html#0918"
			});
		pics.push({ src:"//stagetools.com/primaryaccess/Test8.jpg", 
			title:"Civil rights march on Washington",
			date: "1963",
			desc: "The August 28, 1963, March on Washington riveted the nation&apos;s attention. Rather than the anticipated hundred thousand marchers, more than twice that number appeared, astonishing even its organizers.",
			link: "//memory.loc.gov/ammem/aaohtml/exhibit/aopart9b.html#0913-0914"
			});

/*			"item-1": "name:Image-1;url:http`//memory.loc.gov/pnp/fsa/8e00000/8e00800/8e00810r.jpg;sp:1325,733,6450;ep:500,533,9075;dur:8;ease:both;title:<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>Japanese Internment",
			"item-2": "name:Image-2;url:http`//memory.loc.gov/service/pnp/cph/3a10000/3a18000/3a18700/3a18762r.jpg;sp:150,200,9738;ep:2400,3033,7450;dur:8;ease:both;title:",
			"item-3": "name:Image-3;url:http`//memory.loc.gov/pnp/ppprs/00200/00226v.jpg;sp:3925,1633,3938;ep:263,367,7563;dur:7;ease:both;title:",
			"item-4": "name:Image-4;url:http`//memory.loc.gov/pnp/ppprs/00100/00173v.jpg;sp:2450,917,6513;ep:1450,667,8000;dur:8;ease:both;title:",
			"item-5": "name:Image-5;url:http`//memory.loc.gov/pnp/ppprs/00100/00191r.jpg;sp:2512,3817,4150;ep:1063,517,7788;dur:16;ease:both;title:",
			"item-6": "name:Image-6;url:http`//memory.loc.gov/pnp/ppprs/00100/00115v.jpg;sp:5525,1950,3913;ep:463,1950,8925;dur:15;ease:both;title:",
			"item-7": "name:Image-7;url:http`//memory.loc.gov/pnp/ppprs/00200/00236v.jpg;sp:900,1633,7375;ep:550,533,8500;dur:5;ease:both;title:",
			"item-8": "name:Image-8;url:http`//memory.loc.gov/pnp/ppprs/00200/00237v.jpg;sp:1000,1467,7588;ep:4538,4067,3500;dur:25;ease:both;title:",
			"item-9": "name:Image-9;url:;sp:0,0,10000;ep:0,0,10000;dur:4;ease:both;title:<br/><br/><br/><br/><br/>Thanks to Mrs. Roache <br/>and her <br/>5th grade class <br/>at Buford Middle School",

*/
		return pics;
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DOC
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function CDoc()															// CONSTRUCTOR
	{
	}

	CDoc.prototype.Save=function() 											//	SERIALIZE AND SAVE
	{
		var o={};
		o.script=$("#scriptText").text();										// Get script text 
		o.audioRate=player.audioRate;											// Get rate multiplier
		o.pitch=player.pitch;													// Get TTS pitch
		o.mp3=player.mp3;													// Get audio file
		o.binPics=$.parseJSON(JSON.stringify(bin.pics));						// Clone bin pics
		o.scriptPics=$.parseJSON(JSON.stringify(script.pics));					// Clone script pics
	}

	CDoc.prototype.Load=function() 											//	SERIALIZE
	{
	}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function TimecodeToSeconds(timecode) 									// CONVERT TIMECODE TO SECONDS
		{
			var h=0,m=0;
			var v=(""+timecode).split(":");										// Split by colons
			var s=v[0]															// Add them
			if (v.length == 2)													// Just minutes, seconds
				s=v[1],m=v[0];													// Add them
			else if (v.length == 3)												// Hours, minutes, seconds
				s=v[2],m=v[1],h=v[0];											// Add them
			return(Number(h*3600)+Number(m*60)+Number(s));						// Convert
		}
		
		function SecondsToTimecode(secs) 									// CONVERT SECONDS TO TIMECODE
		{
			var str="",n;
			n=Math.floor(secs/3600);											// Get hours
			if (n) str+=n+":";													// Add to tc
			n=Math.floor(secs/60);												// Get mins
			if (n < 10) str+="0";												// Add leading 0
			str+=n+":";															// Add to tc
			n=Math.floor(secs%60);												// Get secs
			if (n < 10) str+="0";												// Add leading 0
			str+=n;																// Add to tc
			return str;															// Return timecode			
		}	

	function PopUp(msg, time, div)											// TIMED POPUP
	{
		$("#popupDiv").remove();												// Kill old one, if any
		var str="<div id='popupDiv' class='pa-popup'>"+msg+"</div>"; 			// Add div
		$(div ? "#"+div : "body").append(str);									// Add popup to div or body
		$("#popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)		// Animate in and out		
	}

	function DialogBox(title, content, x, y, width, callback, callback2) 	// DIALOG BOX
	{
		$("#dialogDiv").remove();												// Kill old one, if any
		var str="<div id='dialogDiv' class='pa-meta' style='width:"+width+"px'>"; // Add div
		str+="<b>"+title+"</b><br><br>"+content+"<br><br>";						// Content	
		str+="<div style='float:right'>"										// Div to hold buttons
		str+="<div id='okBut' class='pa-bs'>OK</div>&nbsp";						// OK Button
		str+="<div id='cancelBut' class='pa-bs'>Cancel</div></div";				// Cancel
		$("body").append(str+"</div>");											// Add popup
		$("#dialogDiv").offset({ left:x, top:y} );								// Position popup

		$("#okBut").on("click",function() {										// CLICK ON OK
			if (callback)														// If an ok callback spec'd
				callback();														// Run it
			$("#dialogDiv").remove();											// Kill dialog
			});
	
		$("#cancelBut").on("click",function() {									// CLICK ON CANCEL
			if (callback2)														// If a cancel callback spec'd
				callback2();													// Run it
			$("#dialogDiv").remove();											// Kill dialog
			});
	}	

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function mtrace(msg)													// MOBILE TRACE
	{
		$("#scriptTextDiv").text(msg);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
	
</script>
</body>
</html>
